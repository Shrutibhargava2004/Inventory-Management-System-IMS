{% load static %}

<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Sales Dashboard | Inventlix</title>
    <link rel="stylesheet" href="{% static 'css/sales_styles.css' %}">
    <!-- Bootstrap for Modal and Styling -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/js/bootstrap.bundle.min.js"></script>
</head>
<body>
    <div class="container">
        <h1>Welcome, Salesperson</h1>
        
        <div class="row mb-4">
            <div class="col">
                <button class="btn btn-primary" data-bs-toggle="modal" data-bs-target="#addCategoryModal">View Inventory</button>
            </div>
            <div class="col">
                <button class="btn btn-secondary" data-bs-toggle="modal" data-bs-target="#salesHistoryModal">Today's Sales History</button>
            </div>
        </div>

        <!-- Search bar to filter products -->
        <div class="mb-4">
            <input type="text" class="form-control" id="searchBar" placeholder="Search products..." onkeyup="filterProducts()">
        </div>

        <!-- Products List -->
        <h3>Available Products</h3>
        <table class="table">
            <thead>
                <tr>
                    <th scope="col">ID</th>
                    <th scope="col">Product Name</th>
                    <th scope="col">SKU</th>
                    <th scope="col">Category</th>
                    <th scope="col">Price (₹)</th>
                    <th scope="col">Quantity</th>
                    <th scope="col">Select</th>
                </tr>
            </thead>
            <tbody id="productList">
                {% for product in products %}
                <tr>
                    <td>{{ product.id }}</td>
                    <td>{{ product.name }}</td>
                    <td>{{ product.sku_code }}</td>
                    <td>{{ product.category.name }}</td>
                    <td>{{ product.price }}</td>
                    <td>{{ product.quantity }}</td>
                    <td>
                        <input type="number" class="form-control quantity-input" data-id="{{ product.id }}" min="1" max="{{ product.quantity }}" placeholder="Enter quantity" oninput="updateTotal()">
                    </td>
                </tr>
                {% endfor %}
            </tbody>
        </table>

        <!-- Proceed Button (disabled initially) -->
        <button class="btn btn-success" id="proceedButton" data-bs-toggle="modal" data-bs-target="#confirmSaleModal" disabled>Proceed</button>

        <!-- Modal: Confirm Sale -->
        <div class="modal fade" id="confirmSaleModal" tabindex="-1" aria-labelledby="confirmSaleModalLabel" aria-hidden="true">
            <div class="modal-dialog">
                <div class="modal-content">
                    <div class="modal-header">
                        <h5 class="modal-title" id="confirmSaleModalLabel">Confirm Sale</h5>
                        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                    </div>
                    <div class="modal-body">
                        <h4>Selected Products</h4>
                        <ul id="selectedProductsList"></ul>
                        <h5>Total: ₹<span id="totalAmount"></span></h5>
                    </div>
                    <div class="modal-footer">
                        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Back</button>
                        <button type="button" class="btn btn-primary" id="purchaseButton">Purchase</button>
                        <button type="button" class="btn btn-danger" id="cancelSaleButton">Cancel Sale</button>
                    </div>
                </div>
            </div>
        </div>
        
        <!-- Modal: Sales History -->
        <div class="modal fade" id="salesHistoryModal" tabindex="-1" aria-labelledby="salesHistoryModalLabel" aria-hidden="true">
            <div class="modal-dialog">
                <div class="modal-content">
                    <div class="modal-header">
                        <h5 class="modal-title" id="salesHistoryModalLabel">Today's Sales History</h5>
                        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                    </div>
                    <div class="modal-body">
                        <ul id="salesHistoryList">
                            {% for sale in sales %}
                                <li>Sale ID: {{ sale.id }} | Total: ₹{{ sale.total_amount }} | Date: {{ sale.date }}</li>
                            {% endfor %}
                        </ul>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script>
        function filterProducts() {
            let input = document.getElementById("searchBar");
            let filter = input.value.toLowerCase();
            let table = document.getElementById("productList");
            let tr = table.getElementsByTagName("tr");
            
            for (let i = 0; i < tr.length; i++) {
                let td = tr[i].getElementsByTagName("td")[1]; // Product name column
                if (td) {
                    let txtValue = td.textContent || td.innerText;
                    tr[i].style.display = txtValue.toLowerCase().indexOf(filter) > -1 ? "" : "none";
                }
            }
        }

        function updateTotal() {
            let totalAmount = 0;
            let selectedProducts = [];
            document.querySelectorAll(".quantity-input").forEach(input => {
                let quantity = parseInt(input.value);
                let productId = input.getAttribute("data-id");
                let price = parseFloat(input.closest("tr").cells[4].textContent); // Price from the table
                let availableQuantity = parseInt(input.closest("tr").cells[5].textContent); // Available stock
                
                if (quantity > 0 && quantity <= availableQuantity) {
                    totalAmount += price * quantity;
                    selectedProducts.push({ id: productId, name: input.closest("tr").cells[1].textContent, quantity, total: price * quantity });
                }
            });

            // Update total amount
            document.getElementById("totalAmount").textContent = totalAmount.toFixed(2);

            // Update the selected products list
            let selectedProductsList = document.getElementById("selectedProductsList");
            selectedProductsList.innerHTML = "";
            selectedProducts.forEach(product => {
                selectedProductsList.innerHTML += `<li>${product.name} (Quantity: ${product.quantity}) - ₹${product.total.toFixed(2)}</li>`;
            });

            // Enable/disable the Proceed button
            document.getElementById("proceedButton").disabled = selectedProducts.length === 0;
        }

        document.getElementById("purchaseButton").addEventListener("click", function() {
            // Here, you can make an AJAX request to process the sale and update inventory
            alert("Sale completed successfully!");
            window.location.reload();  // Reload to reset the page after successful sale
        });

        document.getElementById("cancelSaleButton").addEventListener("click", function() {
            document.querySelectorAll(".quantity-input").forEach(input => input.value = "");  // Reset all inputs
            updateTotal();
            $('#confirmSaleModal').modal('hide');  // Close modal
        });
    </script>
</body>
</html>
